YUI.add("moodle-qtype_musictheory-musictheoryqtype",function(e,t){M.qtype_musictheory=M.qtype_musictheory||{},M.qtype_musictheory.musictheoryqtype={};var n=M.qtype_musictheory.musictheoryqtype;n.questionRender={},n.initQuestionRender=function(e,t,r,i,s,o){var u=n.questionRender.convertOptionsXMLtoObjectLiteral(t);n.questionRender.renderQuestion(e,u,r,i),s!==null&&typeof s!="undefined"&&s!==""&&n.questionRender.renderCorrectResponse(e,u,s,o)},n.questionRender.renderQuestion=function(t,r,i,s){t=t.replace(":","\\:");var o=e.one("#"+t),u=e.one("#musictheory_div_replacedbycanvas_"+t);u&&u.hide();var a=e.one("#musictheory_div_canvas_"+t);if(!a)return;var f="musictheory_renderMusicCanvas_"+t.replace("\\:","-"),l=e.one("#"+f);l||(l=e.Node.create('<div style="margin-top:10px;margin-bottom:15px"><canvas id="'+f+'" width="1" height="1" /></div>'),a.append(l)),r.editable=!i,r.containsUserInput=!0;var c=new n.XMLConverter(r),h=function(e){o.set("value",c.getCanvasTextOutput(e))},p=c.getCanvasXML(s);new MusThGUI(f,p,h,r.editable),a.show()},n.questionRender.renderCorrectResponse=function(t,r,i,s){t=t.replace(":","\\:");var o=e.one("#musictheory_correctanswerdiv_"+t);if(!o)return;var u="musictheory_renderCorrectResponseCanvas_"+t.replace("\\:","-"),a=e.one("#"+u);a||o.setHTML("<p>"+s+"</p>"+'<canvas id="'+u+'" width="1" height="1" />'),r.editable=!1,r.containsUserInput=!1;var f=new n.XMLConverter(r),l=function(){},c=f.getCanvasXML(i);new MusThGUI(u,c,l,r.editable)},n.questionRender.convertOptionsXMLtoObjectLiteral=function(t){var n=e.XML.parse(t),r={},i=n.getElementsByTagName("options")[0].firstChild,s=i.nodeName;switch(s){case"keysignature-write":case"keysignature-identify":r.musicQType=s,r.clef=i.getElementsByTagName("clef")[0].firstChild.nodeValue,r.key=i.getElementsByTagName("key")[0].firstChild.nodeValue;break;case"interval-write":case"interval-identify":r.musicQType=s,r.clef=i.getElementsByTagName("clef")[0].firstChild.nodeValue,r.givenNote=[],r.givenNote.ltr=i.getElementsByTagName("letter")[0].firstChild.nodeValue,r.givenNote.acc=i.getElementsByTagName("accidental")[0].firstChild.nodeValue,r.givenNote.reg=i.getElementsByTagName("register")[0].firstChild.nodeValue;break;case"scale-write":r.musicQType="scale-write",r.clef=i.getElementsByTagName("clef")[0].firstChild.nodeValue,r.givenNote=[],r.givenNote.ltr=i.getElementsByTagName("letter")[0].firstChild.nodeValue,r.givenNote.acc=i.getElementsByTagName("accidental")[0].firstChild.nodeValue,r.givenNote.reg=i.getElementsByTagName("register")[0].firstChild.nodeValue,r.includeKS=i.getElementsByTagName("displaykeysignature")[0].firstChild.nodeValue,r.includeKS=r.includeKS==="true",r.scaleType=i.getElementsByTagName("scaletype")[0].firstChild.nodeValue}return r},n.editForm={},n.initEditForm=function(){n.editForm.setOptionVisibility(),n.editForm.setFormOptionListeners()},n.editForm.setFormOptionListeners=function(){e.all("#id_musictheory_musicqtype").on("change",function(){var t=e.one("#id_musictheory_updatemusicqtype");t&&t.simulate("click")})},n.editForm.setOptionVisibility=function(){var t=e.one("#id_musictheory_updatemusicqtype");t&&t.hide()},n.getKeySign=function(e,t){var n=e.substring(0,e.length-1),r=e.substr(e.length-1,1),i=[];i.Cn="sharp",i.Gn="sharp",i.Dn="sharp",i.An="sharp",i.En="sharp",i.Bn="sharp",i["F#"]="sharp",i["C#"]="sharp",i.Fn="flat",i.Bb="flat",i.Eb="flat",i.Ab="flat",i.Db="flat",i.Gb="flat",i.Cb="flat";var s=new Array("F#5","C#5","G#5","D#5","A#4","E#5","B#4"),o=new Array("F#3","C#3","G#3","D#3","A#2","E#3","B#2"),u=new Array("F#4","C#4","G#4","D#4","A#3","E#4","B#3"),a=new Array("F#3","C#4","G#3","D#4","A#3","E#4","B#3"),f=new Array("Bb4","Eb5","Ab4","Db5","Gb4","Cb5","Fb4"),l=new Array("Bb2","Eb3","Ab2","Db3","Gb2","Cb3","Fb2"),c=new Array("Bb3","Eb4","Ab3","Db4","Gb3","Cb4","Fb3"),h=new Array("Bb3","Eb4","Ab3","Db4","Gb3","Cb4","Fb3"),p=[];p.treblesharp=s,p.basssharp=o,p.altosharp=u,p.tenorsharp=a,p.trebleflat=f,p.bassflat=l,p.altoflat=c,p.tenorflat=h;var d=[];d.Cn=0,d.Gn=1,d.Dn=2,d.An=3,d.En=4,d.Bn=5,d["F#"]=6,d["C#"]=7,d.Fn=1,d.Bb=2,d.Eb=3,d.Ab=4,d.Db=5,d.Gb=6,d.Cb=7;var v=[];v.An="Cn",v.En="Gn",v.Bn="Dn",v["F#"]="An",v["C#"]="En",v["G#"]="Bn",v["D#"]="F#",v["A#"]="C#",v.Dn="Fn",v.Gn="Bb",v.Cn="Eb",v.Fn="Ab",v.Bb="Db",v.Eb="Gb",v.Ab="Cb";var m=r==="M"?n:v[n],g;return g=p[t+i[m]],g=g.slice(0,d[m]),g},n.XMLConverter=function(e){this.options=e,this.setNotesEditable=e.containsUserInput?!0:!1},n.XMLConverter.prototype.getCanvasXML=function(e){switch(this.options.musicQType){case"keysignature-write":return this.getKSWriteXML(e);case"keysignature-identify":return this.getKSIdentifyXML(e);case"interval-write":return this.getIntervalWriteXML(e);case"interval-identify":return this.getIntervalIdentifyXML(e);case"scale-write":return this.getScaleWriteXML(e);default:return null}},n.XMLConverter.prototype.getCanvasTextOutput=function(e){switch(this.options.musicQType){case"keysignature-write":return this.getKSWriteTextOutput(e);case"keysignature-identify":return this.getKSIdentifyTextOutput();case"interval-write":return this.getIntervalWriteTextOutput(e);case"interval-identify":return this.getIntervalIdentifyTextOutput();case"scale-write":return this.getScaleWriteTextOutput(e);default:return""}return""},n.XMLConverter.prototype.getKSWriteTextOutput=function(t){var n=e.XML.parse(t),r="",i=n.getElementsByTagName("Accidental"),s;for(s=0;s<i.length;s++)r+=i[s].getAttribute("letter")+i[s].getAttribute("type")+i[s].getAttribute("register")+",";return r.length>0?r=r.substr(0,r.length-1):r="",r},n.XMLConverter.prototype.getKSWriteXML=function(e){var t="<MusThGUI>\n";t+='<StaffSystem maxLedgerLines="0">\n',t+='<Staff clef="'+this.options.clef+'">\n',t+='<KeySign totalAccColumns="7">\n';var n;e===""||e===null||typeof e=="undefined"?n=null:n=e.split(",");var r;if(n!==null)for(r=0;r<n.length;r++)t+='<Accidental type="'+n[r].substr(1,1)+'" letter="'+n[r].substr(0,1)+'" register="'+n[r].substr(2,1)+'" editable="'+this.setNotesEditable+'" />\n';return t+="</KeySign>\n"
,t+="</Staff>\n",t+="</StaffSystem>\n",t+="    <Toolbars>\n",t+="        <AccidentalToolbar>\n",t+='            <Button symbol="#"/>\n',t+='            <Button symbol="b"/>\n',t+="        </AccidentalToolbar>\n",t+="    </Toolbars>\n",t+="</MusThGUI>",t},n.XMLConverter.prototype.getKSIdentifyXML=function(e){var t="<MusThGUI>\n";t+='<StaffSystem maxLedgerLines="0">\n',t+='<Staff clef="'+this.options.clef+'">\n',t+='<KeySign totalAccColumns="7">\n';var n;e===""||e===null||typeof e=="undefined"?n=null:n=e.split(",");var r;if(n!==null)for(r=0;r<n.length;r++)t+='<Accidental type="'+n[r].substr(1,1)+'" letter="'+n[r].substr(0,1)+'" register="'+n[r].substr(2,1)+'" editable="false" />\n';return t+="</KeySign>\n",t+="</Staff>\n",t+="</StaffSystem>\n",t+="    <Toolbars>\n",t+="        <AccidentalToolbar>\n",t+='            <Button symbol="#"/>\n',t+='            <Button symbol="b"/>\n',t+="        </AccidentalToolbar>\n",t+="    </Toolbars>\n",t+="</MusThGUI>",t},n.XMLConverter.prototype.getScaleWriteTextOutput=function(t){var n=e.XML.parse(t),r="",i=n.getElementsByTagName("NoteColumn"),s=0,o;for(s=0;s<i.length;s++){o=i[s].getElementsByTagName("Note")[0];if(typeof o!="undefined"&&o!==null){var u;u=o.getAttribute("accidental"),r+=o.getAttribute("letter")+u+o.getAttribute("register")}r+=","}for(s;s<8;s++)r+=",";return r=r.substr(0,r.length-1),r},n.XMLConverter.prototype.getScaleWriteXML=function(e){var t,r,i,s=this.options.givenNote.ltr+this.options.givenNote.acc;this.options.scaleType==="major"?s+="M":s+="m",this.options.includeKS?i=new n.getKeySign(s,this.options.clef):i=[];var o="<MusThGUI>\n";o+='<StaffSystem maxLedgerLines="4">\n',o+='<Staff clef="'+this.options.clef+'">\n',o+='<KeySign totalAccColumns="'+i.length+'">\n';for(t=0;t<i.length;t++)r=this.noteNameToParts(i[t]),o+='<Accidental type="'+r.acc+'" letter="'+r.ltr+'" register="'+r.reg+'" '+'editable="false" />';o+="</KeySign>\n";var u;e===""||e===null||typeof e=="undefined"?u=null:u=e.split(","),o+="<NoteColumns>";if(u!==null)for(t=0;t<u.length;t++)u[t]!==""?(r=this.noteNameToParts(u[t]),o+='<NoteColumn maxNotes="1" >',o+='<Note letter="'+r.ltr+'" ',o+='register="'+r.reg+'" ',o+='accidental="'+r.acc+'" ',t===0?o+='noteValue="whole" editable="false" />':o+='noteValue="whole" editable="'+this.setNotesEditable+'" />',o+="</NoteColumn>"):o+='<NoteColumn maxNotes="1" />';else{var a;this.options.scaleType==="melodic"?a=15:a=8;for(t=0;t<a;t++)t===0?(o+='<NoteColumn maxNotes="1">',o+='<Note letter="'+this.options.givenNote.ltr+'" ',o+='register="'+this.options.givenNote.reg+'" ',o+='accidental="'+this.options.givenNote.acc+'" ',o+='noteValue="whole" editable="false" />',o+="</NoteColumn>"):o+='<NoteColumn maxNotes="1" />'}return o+="</NoteColumns>",o+="</Staff>\n",o+="</StaffSystem>\n",o+="    <Toolbars>\n",o+="        <AccidentalToolbar>\n",o+='            <Button symbol="n"/>',o+='            <Button symbol="#"/>',o+='            <Button symbol="b"/>',o+='            <Button symbol="x"/>',o+='            <Button symbol="bb"/>',o+="        </AccidentalToolbar>\n",o+="    </Toolbars>\n",o+="</MusThGUI>",o},n.XMLConverter.prototype.getIntervalWriteTextOutput=function(t){var n=e.XML.parse(t),r="",i=n.getElementsByTagName("Note"),s=0;for(s=0;s<i.length;s++){var o;i[s].getAttribute("editable")==="true"&&(o=i[s].getAttribute("accidental"),r+=i[s].getAttribute("letter")+o+i[s].getAttribute("register")+",")}return r.length>0?r=r.substr(0,r.length-1):r="",r},n.XMLConverter.prototype.getIntervalWriteXML=function(e){var t="<MusThGUI>";t+='<StaffSystem maxLedgerLines="4">',t+='<Staff clef="'+this.options.clef+'">',t+='<KeySign totalAccColumns="0" >',t+="</KeySign>",t+="<NoteColumns>",t+='<NoteColumn maxNotes="2" >',t+='<Note letter="'+this.options.givenNote.ltr+'" ',t+='register="'+this.options.givenNote.reg+'" ',t+='accidental="'+this.options.givenNote.acc+'" ',t+='noteValue="whole" editable="false" />';if(e!==""&&e!==null&&typeof e!="undefined"){var n=this.noteNameToParts(e);t+='<Note letter="'+n.ltr+'" ',t+='register="'+n.reg+'" ',t+='accidental="'+n.acc+'" ',t+='noteValue="whole" editable="'+this.setNotesEditable+'" />'}return t+="</NoteColumn>",t+="</NoteColumns>",t+="</Staff>",t+="</StaffSystem>",t+="    <Toolbars>\n",t+="        <AccidentalToolbar>\n",t+='            <Button symbol="n"/>',t+='            <Button symbol="#"/>',t+='            <Button symbol="b"/>',t+='            <Button symbol="x"/>',t+='            <Button symbol="bb"/>',t+="        </AccidentalToolbar>\n",t+="    </Toolbars>\n",t+="</MusThGUI>",t},n.XMLConverter.prototype.getIntervalIdentifyXML=function(e){var t="<MusThGUI>";t+='<StaffSystem maxLedgerLines="4">',t+='<Staff clef="'+this.options.clef+'">',t+='<KeySign totalAccColumns="0" >',t+="</KeySign>",t+="<NoteColumns>",t+='<NoteColumn maxNotes="2" >',t+='<Note letter="'+this.options.givenNote.ltr+'" ',t+='register="'+this.options.givenNote.reg+'" ',t+='accidental="'+this.options.givenNote.acc+'" ',t+='noteValue="whole" editable="false" />';if(e!==""&&e!==null&&typeof e!="undefined"){var n=this.noteNameToParts(e);t+='<Note letter="'+n.ltr+'" ',t+='register="'+n.reg+'" ',t+='accidental="'+n.acc+'" ',t+='noteValue="whole" editable="false" />'}return t+="</NoteColumn>",t+="</NoteColumns>",t+="</Staff>",t+="</StaffSystem>",t+="    <Toolbars>\n",t+="        <AccidentalToolbar>\n",t+='            <Button symbol="n"/>',t+='            <Button symbol="#"/>',t+='            <Button symbol="b"/>',t+='            <Button symbol="x"/>',t+='            <Button symbol="bb"/>',t+="        </AccidentalToolbar>\n",t+="    </Toolbars>\n",t+="</MusThGUI>",t},n.XMLConverter.prototype.noteNameToParts=function(e){var t=[];return t.ltr=e.substr(0,1),t.reg=e.substr(e.length-1,1),e.length===2?t.acc="n":t.acc=e.substring(1,e.length-1),t}},"@VERSION@",{requires:["base","node","datatype","node-event-simulate"]});
